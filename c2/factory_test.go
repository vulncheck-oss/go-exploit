package c2

import (
	"testing"

	"github.com/vulncheck-oss/go-exploit/c2/channel"
	"github.com/vulncheck-oss/go-exploit/c2/httpservefile"
)

func TestHTTPServeFileInit(t *testing.T) {
	impl, success := GetInstance(HTTPServeFile)
	if !success {
		t.Fatal("Failed to create HTTPServeFile")
	}

	if len(httpservefile.GetInstance().HostedFiles) != 0 {
		t.Fatal("Instance has a filename already")
	}

	success = impl.Init(channel.Channel{IPAddr: "127.0.0.1", Port: 1270, IsClient: false})
	if success {
		t.Fatal("Should have failed to init the instance")
	}
	httpservefile.GetInstance().FilesToServe = "factory.go"
	success = impl.Init(channel.Channel{IPAddr: "127.0.0.1", Port: 1270, IsClient: true})
	if success {
		t.Fatal("Failed to check if it was invoked as a client")
	}

	// random name should have been generated
	if len(httpservefile.GetInstance().HostedFiles["factory.go"].RandomName) != 0 {
		t.Fatal("Instance did not generate a random filename")
	}
	if httpservefile.GetInstance().HTTPAddr != "127.0.0.1" {
		t.Fatal("Instance did not take up the http bind addr")
	}
	if httpservefile.GetInstance().HTTPPort != 1270 {
		t.Fatal("Instance did not take up the http bind port")
	}
}
